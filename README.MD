
# ðŸ§© FastAPI Microservice â€“ User & Widget API ![Python](https://img.shields.io/badge/Python-3.13-blue) ![FastAPI](https://img.shields.io/badge/FastAPI-0.115.12-green) ![MongoDB](https://img.shields.io/badge/MongoDB-8.0.9-success) ![Docker](https://img.shields.io/badge/Docker-4.41-blue)

### ðŸ”§ Project Overview

A **complete microservice API** built with **FastAPI**, providing full REST support for **user** and **widget** resources. It features **JWT authentication**, **role-based access control**, **Redis caching**, and **MongoDB** as the data store. Monitoring is handled via **Prometheus** and **Grafana**. The system is containerized with **Docker** and deployed using **Kubernetes**.

![Grafana_dashboard](https://github.com/Kinetics20/project/blob/main/microservice/docs/grafana_dashboard.jpg)

![Prometheus_target_health](https://github.com/Kinetics20/project/blob/main/microservice/docs/prometheus.jpg)

---

### ðŸ§± Tech Stack

- **Python 3.13+**
- **FastAPI** â€“ high-performance async web framework
- **MongoDB** â€“ data persistence
- **Redis** â€“ in-memory cache store
- **Prometheus + Grafana** â€“ monitoring and visualization
- **Docker Desktop** â€“ image containerization
- **Kubernetes** â€“ container orchestration
- **uv** â€“ Python dependency manager

---

### ðŸ—‚ Project Structure

```bash
project/
â”œâ”€â”€ microservice/
â”‚   â”œâ”€â”€ api/                    # FastAPI logic
â”‚   â”‚   â”œâ”€â”€ .cert/              # Certificate files (SSL)
â”‚   â”‚   â”œâ”€â”€ core/               # Configuration, DB, RBAC
â”‚   â”‚   â”œâ”€â”€ models/             # MongoDB models
â”‚   â”‚   â”œâ”€â”€ schemas/            # Pydantic schemas
â”‚   â”‚   â”œâ”€â”€ scripts/            # Grafana dashboard
â”‚   â”‚   â”œâ”€â”€ utils/              # Utilities (e.g., sanitizer)
â”‚   â”‚   â”œâ”€â”€ Dockerfile          # API image definition
â”‚   â”‚   â””â”€â”€ main.py             # App entry point
â”‚   â”œâ”€â”€ .k8s/                   # Kubernetes manifests
â”‚   â”‚   â”œâ”€â”€ mongodb.yml
â”‚   â”‚   â”œâ”€â”€ redis.yml
â”‚   â”‚   â”œâ”€â”€ secret.yml
â”‚   â”‚   â”œâ”€â”€ service.yml
â”‚   â”‚   â”œâ”€â”€ deployment.yml
â”‚   â”‚   â””â”€â”€ prometheus/
â””â”€â”€ README.md
````

---

### âœ… Features

* User registration and login (with password hashing)
* JWT-based authentication
* Role-Based Access Control (RBAC)
* Widget CRUD functionality
* Redis-based caching
* MongoDB database backend
* Prometheus + Grafana monitoring
* Kubernetes-based deployment

---

### ðŸš€ Getting Started

#### 1. Clone the repository

```bash
git clone git@github.com:Kinetics20/project.git
cd project/microservice/api
```

#### 2. Install dependencies with `uv`

```bash
uv sync
```

#### 3. Generate SSL certificates

Navigate to the `.cert` directory and run:

```bash
cd microservice/api/.cert
openssl req -x509 --nodes -days 365 -newkey rsa:2048 -keyout key.pem -out cert.pem
```

These are used for secure authorization.

#### 4. Build Docker image

Go back to the `api` directory and build the Docker image:

```bash
cd ..
docker build -t fast:9 .
```

> If you change the image name (`fast:9`), update it in `.k8s/deployment.yml` under `containers.image`.

---

### â˜¸ï¸ Kubernetes Deployment

Ensure you have `kubectl` installed:

```bash
sudo snap install kubectl --classic
```

Apply manifests in the `.k8s` directory:

```bash
cd ../.k8s
kubectl apply -f mongodb.yml
kubectl apply -f redis.yml
kubectl apply -f secret.yml
kubectl apply -f service.yml
kubectl apply -f deployment.yml
```

---

### ðŸ” Check Deployment Status

```bash
kubectl get pods
```

Example output:

```
NAME                          READY   STATUS    RESTARTS   AGE
mongodb-0                     1/1     Running   ...         ...
redis-xxxxxxx                 1/1     Running   ...         ...
widget-api-xxxxxxx            1/1     Running   ...         ...
```

For monitoring (namespace `monitoring`):

```bash
kubectl get pods -n monitoring
```

---

### ðŸ“‘ API Documentation

Once the application is running, you can access the interactive documentation at:

```
http://localhost/docs
```


![Swagger UI](https://github.com/Kinetics20/project/blob/main/microservice/docs/widget_Api.jpg)

---

### ðŸ” Authentication Workflow (Required to Use the API)

To successfully use all CRUD operations on users and widgets, follow these steps:

1. **Create an admin user**  
   - Go to the `users` section â†’ `POST /users/`
   - Provide user details and set the `status` field to `admin`
   - Example payload:
     ```json
     {
       "username": "adminuser",
       "password": "yourpassword",
       "status": "admin"
     }
     ```

2. **Authorize the session**  
   - Click the **Authorize** button in the top right of the Swagger UI
   - Enter the JWT token you received after logging in as the admin user

3. **Start making authenticated requests**  
   - After successful authorization, you can now:
     - Create, read, update, and delete users
     - Perform all widget operations (CRUD)
     - Access endpoints protected by authentication

> âš ï¸ **Note**: If the user is not created with `"status": "admin"`, access to certain endpoints will be restricted.

---

### ðŸ“Š Monitoring with Prometheus and Grafana

This project includes a full monitoring setup using **Prometheus** and **Grafana**, deployed via **Helm**.

---

### ðŸ”§ 1. Install Helm

First, install Helm on your system:

```bash
curl https://baltocdn.com/helm/signing.asc | gpg --dearmor | sudo tee /usr/share/keyrings/helm.gpg > /dev/null
sudo apt-get install apt-transport-https --yes
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/helm.gpg] https://baltocdn.com/helm/stable/debian/ all main" | sudo tee /etc/apt/sources.list.d/helm-stable-debian.list
sudo apt-get update
sudo apt-get install helm
````

---

### ðŸ“¦ 2. Add Helm Repositories

```bash
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo add grafana https://grafana.github.io/helm-charts
helm repo update
```

---

### ðŸ§  3. Create Monitoring Namespace

```bash
kubectl create namespace monitoring
```

---

### ðŸ“ˆ 4. Install Prometheus

```bash
helm install prometheus prometheus-community/prometheus \
  --namespace monitoring \
  --set alertmanager.persistentVolume.storageClass=hostpath \
  --set server.persistentVolume.storageClass=hostpath \
  --values - <<EOF
server:
  additionalScrapeConfigs:
    - job_name: 'widget-api'
      static_configs:
        - targets: ['widget-api:80']
EOF
```

This configures Prometheus to scrape metrics from the `widget-api` container.

---

### ðŸ“‰ 5. Install Grafana

```bash
helm install grafana grafana/grafana \
  --namespace monitoring \
  --set persistence.storageClassName=hostpath \
  --set persistence.enabled=true \
  --set adminPassword='admin' \
  --values - <<EOF
datasources:
  datasources.yaml:
    apiVersion: 1
    datasources:
    - name: Prometheus
      type: prometheus
      url: http://prometheus-server.monitoring.svc.cluster.local
      access: proxy
      isDefault: true
EOF
```

Login credentials:

* **Username**: `admin`
* **Password**: `admin`

---

### ðŸ”Œ 6. Port Forwarding

Forward ports locally to access both dashboards in your browser:

```bash
kubectl port-forward -n monitoring svc/grafana 3000:80
```

Grafana will be available at:

```
http://localhost:3000
```

```bash
kubectl port-forward -n monitoring svc/prometheus-server 3001:80
```

Prometheus will be available at:

```
http://localhost:3001
```

---

### ðŸ§¾ 7. Import Dashboard in Grafana

To visualize metrics from the `widget-api`, import the preconfigured dashboard:

1. Open Grafana â†’ **Dashboards** â†’ **Create** â†’ **Import**
2. Use the file located at:

   ```
   microservice/api/scripts/grafana-dashboard.json
   ```
3. You can upload the file or paste the raw JSON into the text editor.

> âœ… The dashboard will show live metrics from Prometheus such as pod health, API performance, and request frequency.


---
### ðŸ“¦ Author

ðŸ‘¤ **Piotr LipiÅ„ski**
ðŸ—“ **Finished**: July 2025
ðŸ“« Contributions welcome!
